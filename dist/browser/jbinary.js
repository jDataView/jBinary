!function(a){var b=function(){return this}();"object"==typeof exports?module.exports=a.call(b,require("jdataview")):"function"==typeof define&&define.amd?define(["jdataview"],function(){a.apply(b,arguments)}):b.jBinary=a.call(b,b.jDataView)}(function(a){"use strict";function b(a){for(var b=1,c=arguments.length;c>b;++b){var d=arguments[b];for(var e in d)void 0!==d[e]&&(a[e]=d[e])}return a}function c(a){return arguments[0]=i(a),b.apply(null,arguments)}function d(a,b,c){return c instanceof Function?c.call(a,b.contexts[0]):c}function e(a){return function(){if("function"==typeof arguments[arguments.length-1])return a.apply(this,arguments);var b=arguments;return{then:function(c,d){return Array.prototype.push.call(b,function(a,b){return a?d(a):c(b)}),a.apply(this,b)}}}}function f(b,c){return b instanceof f?b.as(c):(b instanceof a||(b=new a(b,void 0,void 0,c?c["jBinary.littleEndian"]:void 0)),this instanceof f?(this.view=b,this.view.seek(0),this.contexts=[],this.as(c,!0)):new f(b,c))}var g=this;if("atob"in g&&"btoa"in g||!function(){var a=g,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=function(){try{document.createElement("$")}catch(a){return a}}();a.btoa||(a.btoa=function(a){for(var d,e,f=0,g=b,h="";a.charAt(0|f)||(g="=",f%1);h+=g.charAt(63&d>>8-8*(f%1))){if(e=a.charCodeAt(f+=.75),e>255)throw c;d=d<<8|e}return h}),a.atob||(a.atob=function(a){if(a=a.replace(/=+$/,""),1==a.length%4)throw c;for(var d,e,f=0,g=0,h="";e=a.charAt(g++);~e&&(d=f%4?64*d+e:e,f++%4)?h+=String.fromCharCode(255&d>>(6&-2*f)):0)e=b.indexOf(e);return h})}(),!a){var h="jBinary_activate";g[h]=function(){try{delete g[h]}catch(b){g[h]=void 0}a=g.jDataView},document.write('<script src="//jdataview.github.io/dist/jdataview.js"></script><script>'+h+"()</script>")}var i=Object.create||function(a){var b=function(){};return b.prototype=a,new b},j=Object.defineProperty;if(j)try{j({},"x",{})}catch(k){j=null}j||(j=function(a,b,c,d){d&&(a[b]=c.value)});var l=f.prototype;l.cacheKey="jBinary.Cache",l.id=0,l._getCached=function(a,b,c){if(a.hasOwnProperty(this.cacheKey))return a[this.cacheKey];var d=b.call(this,a);return j(a,this.cacheKey,{value:d},c),d},l.getContext=function(a){switch(typeof a){case"undefined":a=0;case"number":return this.contexts[a];case"string":return this.getContext(function(b){return a in b});case"function":for(var b=0,c=this.contexts.length;c>b;b++){var d=this.contexts[b];if(a.call(this,d))return d}return}},l.inContext=function(a,b){this.contexts.unshift(a);var c=b.call(this);return this.contexts.shift(),c},f.Type=function(a){return c(f.Type.prototype,a)},f.Type.prototype={inherit:function(a,b){function d(a,b){var d=f[a];d&&(e||(e=c(f)),b.call(e,d),e[a]=null)}var e,f=this;return d("params",function(b){for(var c=0,d=Math.min(b.length,a.length);d>c;c++)this[b[c]]=a[c]}),d("setParams",function(b){b.apply(this,a)}),d("typeParams",function(a){for(var c=0,d=a.length;d>c;c++){var e=a[c],f=this[e];f&&(this[e]=b(f))}}),d("resolve",function(a){a.call(this,b)}),e||f},createProperty:function(a){return c(this,{binary:a})},toValue:function(a,b){return b!==!1&&"string"==typeof a?this.binary.getContext(a)[a]:d(this,this.binary,a)}},f.Template=function(a){return c(f.Template.prototype,a,{createProperty:function(){var b=(a.createProperty||f.Template.prototype.createProperty).apply(this,arguments);return b.getBaseType&&(b.baseType=b.binary.getType(b.getBaseType(b.binary.contexts[0]))),b}})},f.Template.prototype=c(f.Type.prototype,{setParams:function(){this.baseType&&(this.typeParams=["baseType"].concat(this.typeParams||[]))},baseRead:function(){return this.binary.read(this.baseType)},baseWrite:function(a){return this.binary.write(this.baseType,a)}}),f.Template.prototype.read=f.Template.prototype.baseRead,f.Template.prototype.write=f.Template.prototype.baseWrite,l.typeSet={extend:f.Type({setParams:function(){this.parts=arguments},resolve:function(a){for(var b=this.parts,c=b.length,d=new Array(c),e=0;c>e;e++)d[e]=a(b[e]);this.parts=d},read:function(){var a=this.parts,c=this.binary.read(a[0]);return this.binary.inContext(c,function(){for(var d=1,e=a.length;e>d;d++)b(c,this.read(a[d]))}),c},write:function(a){var b=this.parts;this.binary.inContext(a,function(){for(var c=0,d=b.length;d>c;c++)this.write(b[c],a)})}}),"enum":f.Template({params:["baseType","matches"],setParams:function(a,b){this.backMatches={};for(var c in b)this.backMatches[b[c]]=c},read:function(){var a=this.baseRead();return a in this.matches?this.matches[a]:a},write:function(a){this.baseWrite(a in this.backMatches?this.backMatches[a]:a)}}),string:f.Template({params:["length","encoding"],read:function(){return this.binary.view.getString(this.toValue(this.length),void 0,this.encoding)},write:function(a){this.binary.view.writeString(a,this.encoding)}}),string0:f.Type({params:["length","encoding"],read:function(){var a=this.binary.view,b=this.length;if(void 0===b){var c,d=a.tell(),e=0;for(b=a.byteLength-d;b>e&&(c=a.getUint8());)e++;var f=a.getString(e,d,this.encoding);return b>e&&a.skip(1),f}return a.getString(b,void 0,this.encoding).replace(/\0.*$/,"")},write:function(a){var b=this.binary.view,c=void 0===this.length?1:this.length-a.length;b.writeString(a,void 0,this.encoding),c>0&&(b.writeUint8(0),b.skip(c-1))}}),array:f.Template({params:["baseType","length"],read:function(){var a=this.toValue(this.length);if(this.baseType===l.typeSet.uint8)return this.binary.view.getBytes(a,void 0,!0,!0);var b;if(void 0!==a){b=new Array(a);for(var c=0;a>c;c++)b[c]=this.baseRead()}else{var d=this.binary.view.byteLength;for(b=[];this.binary.tell()<d;)b.push(this.baseRead())}return b},write:function(a){if(this.baseType===l.typeSet.uint8)return this.binary.view.writeBytes(a);for(var b=0,c=a.length;c>b;b++)this.baseWrite(a[b])}}),object:f.Type({params:["structure","proto"],resolve:function(a){var b={};for(var c in this.structure)b[c]=this.structure[c]instanceof Function?this.structure[c]:a(this.structure[c]);this.structure=b},read:function(){var a=this,b=this.structure,d=this.proto?c(this.proto):{};return this.binary.inContext(d,function(){for(var c in b){var e=b[c]instanceof Function?b[c].call(a,this.contexts[0]):this.read(b[c]);void 0!==e&&(d[c]=e)}}),d},write:function(a){var b=this,c=this.structure;this.binary.inContext(a,function(){for(var d in c)c[d]instanceof Function?a[d]=c[d].call(b,this.contexts[0]):this.write(c[d],a[d])})}}),bitfield:f.Type({params:["bitSize"],read:function(){return this.binary.view.getUnsigned(this.bitSize)},write:function(a){this.binary.view.writeUnsigned(a,this.bitSize)}}),"if":f.Template({params:["condition","trueType","falseType"],typeParams:["trueType","falseType"],getBaseType:function(){return this.toValue(this.condition)?this.trueType:this.falseType}}),if_not:f.Template({setParams:function(a,b,c){this.baseType=["if",a,c,b]}}),"const":f.Template({params:["baseType","value","strict"],read:function(){var a=this.baseRead();if(this.strict&&a!==this.value){if(this.strict instanceof Function)return this.strict(a);throw new TypeError("Unexpected value.")}return a},write:function(a){this.baseWrite(this.strict||void 0===a?this.value:a)}}),skip:f.Type({setParams:function(a){this.read=this.write=function(){this.binary.view.skip(this.toValue(a))}}}),blob:f.Type({params:["length"],read:function(){return this.binary.view.getBytes(this.toValue(this.length))},write:function(a){this.binary.view.writeBytes(a,!0)}}),binary:f.Template({params:["length","typeSet"],read:function(){var a=this.binary.tell(),b=this.binary.skip(this.toValue(this.length)),c=this.binary.view.slice(a,b);return new f(c,this.typeSet)},write:function(a){this.binary.write("blob",a.read("blob",0))}}),lazy:f.Template({marker:"jBinary.Lazy",params:["innerType","length"],getBaseType:function(){return["binary",this.length,this.binary.typeSet]},read:function(){var a=function(c){return 0===arguments.length?"value"in a?a.value:a.value=a.binary.read(a.innerType):b(a,{wasChanged:!0,value:c}).value};return a[this.marker]=!0,b(a,{binary:b(this.baseRead(),{contexts:this.binary.contexts.slice()}),innerType:this.innerType})},write:function(a){a.wasChanged||!a[this.marker]?this.binary.write(this.innerType,a()):this.baseWrite(a.binary)}})},l.as=function(a,b){var d=b?this:c(this);return a=a||l.typeSet,d.typeSet=l.typeSet===a||l.typeSet.isPrototypeOf(a)?a:c(l.typeSet,a),d.cacheKey=l.cacheKey,d.cacheKey=d._getCached(a,function(){return l.cacheKey+"."+ ++l.id},!0),d};var m=f.Type({params:["littleEndian"],read:function(){return this.binary.view["get"+this.dataType](void 0,this.littleEndian)},write:function(a){this.binary.view["write"+this.dataType](a,this.littleEndian)}});!function(a){for(var b=0,d=a.length;d>b;b++){var e=a[b];l.typeSet[e.toLowerCase()]=c(m,{dataType:e})}}(["Uint8","Uint16","Uint32","Uint64","Int8","Int16","Int32","Int64","Float32","Float64","Char"]),b(l.typeSet,{"byte":l.typeSet.uint8,"float":l.typeSet.float32,"double":l.typeSet.float64}),l.toValue=function(a){return d(this,this,a)},l.seek=function(a,b){if(a=this.toValue(a),void 0!==b){var c=this.view.tell();this.view.seek(a);var d=b.call(this);return this.view.seek(c),d}return this.view.seek(a)},l.tell=function(){return this.view.tell()},l.skip=function(a,b){return this.seek(this.tell()+this.toValue(a),b)},l.getType=function(a,b){switch(typeof a){case"string":if(!(a in this.typeSet))throw new ReferenceError("Unknown type `"+a+"`");return this.getType(this.typeSet[a],b);case"number":return this.getType(l.typeSet.bitfield,[a]);case"object":if(a instanceof f.Type){var c=this;return a.inherit(b||[],function(a){return c.getType(a)})}var d=a instanceof Array;return this._getCached(a,d?function(a){return this.getType(a[0],a.slice(1))}:function(a){return this.getType(l.typeSet.object,[a])},d)}},l.createProperty=function(a){return this.getType(a).createProperty(this)},l._action=function(a,b,c){return void 0!==a?void 0!==b?this.seek(b,c):c.call(this):void 0},l.read=function(a,b){return this._action(a,b,function(){return this.createProperty(a).read(this.contexts[0])})},l.readAll=function(){return this.read("jBinary.all",0)},l.write=function(a,b,c){return this._action(a,c,function(){var c=this.tell();return this.createProperty(a).write(b,this.contexts[0]),this.tell()-c})},l.writeAll=function(a){return this.write("jBinary.all",a,0)},l._toURI="URL"in g&&"createObjectURL"in URL?function(a){var b=this.seek(0,function(){return this.view.getBytes()});return URL.createObjectURL(new Blob([b],{type:a}))}:function(a){var b=this.seek(0,function(){return this.view.getString(void 0,void 0,"binary")});return"data:"+a+";base64,"+btoa(b)},l.toURI=function(a){return this._toURI(a||this.typeSet["jBinary.mimeType"]||"application/octet-stream")},l.slice=function(a,b,c){return new f(this.view.slice(a,b,c),this.typeSet)};return f.loadData=e(function(a,b){var c;switch(!0){case!0&&"Blob"in g&&a instanceof Blob:var d=new FileReader;return d.onload=d.onerror=function(){b(this.error,this.result)},d.readAsArrayBuffer(a),void 0;case!1:var e=[];return a.on("readable",function(){e.push(this.read())}).on("end",function(){b(null,Buffer.concat(e))}).on("error",b),void 0;case"string"!=typeof a:return b(new TypeError("Unsupported source type."));case!!(c=a.match(/^data:(.+?)(;base64)?,(.*)$/)):try{var f=c[2],h=c[3];b(null,(f?atob:decodeURIComponent)(h))}catch(i){b(i)}return;case!0&&"XMLHttpRequest"in g:var j=new XMLHttpRequest;j.open("GET",a,!0),"responseType"in j?j.responseType="arraybuffer":"overrideMimeType"in j?j.overrideMimeType("text/plain; charset=x-user-defined"):j.setRequestHeader("Accept-Charset","x-user-defined"),"onload"in j||(j.onreadystatechange=function(){4===this.readyState&&this.onload()});var k=function(a){b(new Error(a))};return j.onload=function(){return 0!==this.status&&200!==this.status?k("HTTP Error #"+this.status+": "+this.statusText):("response"in this||(this.response=new VBArray(this.responseBody).toArray()),b(null,this.response),void 0)},j.onerror=function(){k("Network error.")},j.send(null),void 0;case!0:return b(new TypeError("Unsupported source type."));case!1:return require("request").get({uri:a,encoding:null},function(a,c,d){if(!a&&200!==c.statusCode){var e=require("http").STATUS_CODES[c.statusCode];a=new Error("HTTP Error #"+c.statusCode+": "+e)}b(a,d)}),void 0;case!1:require("fs").readFile(a,b)}}),f.load=e(function(a,b,c){"function"==typeof b&&(c=b,b=void 0),f.loadData(a,function(a,d){a?c(a):c(null,new f(d,b))})}),f});
//# sourceMappingURL=jbinary.js.map