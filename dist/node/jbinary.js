!function(a){var b=function(){return this}();"object"==typeof exports?module.exports=a.call(b,require("jdataview")):"function"==typeof define&&define.amd?define(["jdataview"],function(){a.apply(b,arguments)}):b.jBinary=a.call(b,b.jDataView)}(function(a){"use strict";function b(a){for(var b=1,c=arguments.length;c>b;++b){var d=arguments[b];for(var e in d)void 0!==d[e]&&(a[e]=d[e])}return a}function c(a){return arguments[0]=j(a),b.apply(null,arguments)}function d(a,b,c){return c instanceof Function?c.call(a,b.contexts[0]):c}function e(a){return function(){if("function"==typeof arguments[arguments.length-1])return a.apply(this,arguments);var b=this,c=arguments;return{then:function(d,e){return Array.prototype.push.call(c,function(a,b){return a?e(a):d(b)}),a.apply(b,c)}}}}function f(b,c){return b instanceof f?b.as(c):(b instanceof a||(b=new a(b,void 0,void 0,c?c["jBinary.littleEndian"]:void 0)),this instanceof f?(this.view=b,this.view.seek(0),this.contexts=[],this.as(c,!0)):new f(b,c))}function g(a){return c(g.prototype,a)}function h(a){return c(h.prototype,a,{createProperty:function(){var b=(a.createProperty||h.prototype.createProperty).apply(this,arguments);return b.getBaseType&&(b.baseType=b.binary.getType(b.getBaseType(b.binary.contexts[0]))),b}})}var i=this;"atob"in i&&"btoa"in i||!function(){var a=i,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=function(){try{document.createElement("$")}catch(a){return a}}();a.btoa||(a.btoa=function(a){for(var d,e,f=0,g=b,h="";a.charAt(0|f)||(g="=",f%1);h+=g.charAt(63&d>>8-8*(f%1))){if(e=a.charCodeAt(f+=.75),e>255)throw c;d=d<<8|e}return h}),a.atob||(a.atob=function(a){if(a=a.replace(/=+$/,""),1==a.length%4)throw c;for(var d,e,f=0,g=0,h="";e=a.charAt(g++);~e&&(d=f%4?64*d+e:e,f++%4)?h+=String.fromCharCode(255&d>>(6&-2*f)):0)e=b.indexOf(e);return h})}();var j=Object.create||function(a){var b=function(){};return b.prototype=a,new b},k=Object.defineProperty;k||(k=function(a,b,c,d){d&&(a[b]=c.value)});var l=f.prototype;l.cacheKey="jBinary.Cache",l.id=0,l._getCached=function(a,b,c){if(a.hasOwnProperty(this.cacheKey))return a[this.cacheKey];var d=b.call(this,a);return k(a,this.cacheKey,{value:d},c),d},l.toValue=function(a){return d(this,this,a)},l.getContext=function(a){switch(typeof a){case"undefined":a=0;case"number":return this.contexts[a];case"string":return this.getContext(function(b){return a in b});case"function":for(var b=0,c=this.contexts.length;c>b;b++){var d=this.contexts[b];if(a.call(this,d))return d}return}},l.inContext=function(a,b){this.contexts.unshift(a);var c=b.call(this);return this.contexts.shift(),c},g.prototype={inherit:function(a,b){function d(a,b){var d=f[a];d&&(e||(e=c(f)),b.call(e,d),e[a]=null)}var e,f=this;return d("params",function(b){for(var c=0,d=Math.min(b.length,a.length);d>c;c++)this[b[c]]=a[c]}),d("setParams",function(b){b.apply(this,a)}),d("typeParams",function(a){for(var c=0,d=a.length;d>c;c++){var e=a[c],f=this[e];f&&(this[e]=b(f))}}),d("resolve",function(a){a.call(this,b)}),e||f},createProperty:function(a){return c(this,{binary:a,view:a.view})},toValue:function(a,b){return b!==!1&&"string"==typeof a?this.binary.getContext(a)[a]:d(this,this.binary,a)}},f.Type=g,h.prototype=c(g.prototype,{setParams:function(){this.baseType&&(this.typeParams=["baseType"].concat(this.typeParams||[]))},baseRead:function(){return this.binary.read(this.baseType)},baseWrite:function(a){return this.binary.write(this.baseType,a)}}),b(h.prototype,{read:h.prototype.baseRead,write:h.prototype.baseWrite}),f.Template=h,l.typeSet={extend:g({setParams:function(){this.parts=arguments},resolve:function(a){for(var b=this.parts,c=b.length,d=new Array(c),e=0;c>e;e++)d[e]=a(b[e]);this.parts=d},read:function(){var a=this.parts,c=this.binary.read(a[0]);return this.binary.inContext(c,function(){for(var d=1,e=a.length;e>d;d++)b(c,this.read(a[d]))}),c},write:function(a){var b=this.parts;this.binary.inContext(a,function(){for(var c=0,d=b.length;d>c;c++)this.write(b[c],a)})}}),"enum":h({params:["baseType","matches"],setParams:function(a,b){this.backMatches={};for(var c in b)this.backMatches[b[c]]=c},read:function(){var a=this.baseRead();return a in this.matches?this.matches[a]:a},write:function(a){this.baseWrite(a in this.backMatches?this.backMatches[a]:a)}}),string:h({params:["length","encoding"],read:function(){return this.view.getString(this.toValue(this.length),void 0,this.encoding)},write:function(a){this.view.writeString(a,this.encoding)}}),string0:g({params:["length","encoding"],read:function(){var a=this.view,b=this.length;if(void 0===b){var c,d=a.tell(),e=0;for(b=a.byteLength-d;b>e&&(c=a.getUint8());)e++;var f=a.getString(e,d,this.encoding);return b>e&&a.skip(1),f}return a.getString(b,void 0,this.encoding).replace(/\0.*$/,"")},write:function(a){var b=this.view,c=void 0===this.length?1:this.length-a.length;b.writeString(a,void 0,this.encoding),c>0&&(b.writeUint8(0),b.skip(c-1))}}),array:h({params:["baseType","length"],read:function(){var a=this.toValue(this.length);if(this.baseType===l.typeSet.uint8)return this.view.getBytes(a,void 0,!0,!0);var b;if(void 0!==a){b=new Array(a);for(var c=0;a>c;c++)b[c]=this.baseRead()}else{var d=this.view.byteLength;for(b=[];this.binary.tell()<d;)b.push(this.baseRead())}return b},write:function(a){if(this.baseType===l.typeSet.uint8)return this.view.writeBytes(a);for(var b=0,c=a.length;c>b;b++)this.baseWrite(a[b])}}),object:g({params:["structure","proto"],resolve:function(a){var b={};for(var c in this.structure)b[c]=this.structure[c]instanceof Function?this.structure[c]:a(this.structure[c]);this.structure=b},read:function(){var a=this,b=this.structure,d=this.proto?c(this.proto):{};return this.binary.inContext(d,function(){for(var c in b){var e=b[c]instanceof Function?b[c].call(a,this.contexts[0]):this.read(b[c]);void 0!==e&&(d[c]=e)}}),d},write:function(a){var b=this,c=this.structure;this.binary.inContext(a,function(){for(var d in c)c[d]instanceof Function?a[d]=c[d].call(b,this.contexts[0]):this.write(c[d],a[d])})}}),bitfield:g({params:["bitSize"],read:function(){return this.view.getUnsigned(this.bitSize)},write:function(a){this.view.writeUnsigned(a,this.bitSize)}}),"if":h({params:["condition","trueType","falseType"],typeParams:["trueType","falseType"],getBaseType:function(){return this.toValue(this.condition)?this.trueType:this.falseType}}),if_not:h({setParams:function(a,b,c){this.baseType=["if",a,c,b]}}),"const":h({params:["baseType","value","strict"],read:function(){var a=this.baseRead();if(this.strict&&a!==this.value){if(this.strict instanceof Function)return this.strict(a);throw new TypeError("Unexpected value.")}return a},write:function(a){this.baseWrite(this.strict||void 0===a?this.value:a)}}),skip:g({params:["length"],read:function(){this.view.skip(this.toValue(this.length))},write:function(){this.read()}}),blob:g({params:["length"],read:function(){return this.view.getBytes(this.toValue(this.length))},write:function(a){this.view.writeBytes(a,!0)}}),binary:h({params:["length","typeSet"],read:function(){var a=this.binary.tell(),b=this.binary.skip(this.toValue(this.length)),c=this.view.slice(a,b);return new f(c,this.typeSet)},write:function(a){this.binary.write("blob",a.read("blob",0))}}),lazy:h({marker:"jBinary.Lazy",params:["innerType","length"],getBaseType:function(){return["binary",this.length,this.binary.typeSet]},read:function(){var a=function(c){return 0===arguments.length?"value"in a?a.value:a.value=a.binary.read(a.innerType):b(a,{wasChanged:!0,value:c}).value};return a[this.marker]=!0,b(a,{binary:b(this.baseRead(),{contexts:this.binary.contexts.slice()}),innerType:this.innerType})},write:function(a){a.wasChanged||!a[this.marker]?this.binary.write(this.innerType,a()):this.baseWrite(a.binary)}})},l.as=function(a,b){var d=b?this:c(this);return a=a||l.typeSet,d.typeSet=l.typeSet===a||l.typeSet.isPrototypeOf(a)?a:c(l.typeSet,a),d.cacheKey=l.cacheKey,d.cacheKey=d._getCached(a,function(){return l.cacheKey+"."+ ++l.id},!0),d},l.seek=function(a,b){if(a=this.toValue(a),void 0!==b){var c=this.view.tell();this.view.seek(a);var d=b.call(this);return this.view.seek(c),d}return this.view.seek(a)},l.tell=function(){return this.view.tell()},l.skip=function(a,b){return this.seek(this.tell()+this.toValue(a),b)},l.slice=function(a,b,c){return new f(this.view.slice(a,b,c),this.typeSet)},l.getType=function(a,b){switch(typeof a){case"string":if(!(a in this.typeSet))throw new ReferenceError("Unknown type `"+a+"`");return this.getType(this.typeSet[a],b);case"number":return this.getType(l.typeSet.bitfield,[a]);case"object":if(a instanceof f.Type){var c=this;return a.inherit(b||[],function(a){return c.getType(a)})}var d=a instanceof Array;return this._getCached(a,d?function(a){return this.getType(a[0],a.slice(1))}:function(a){return this.getType(l.typeSet.object,[a])},d)}},l.createProperty=function(a){return this.getType(a).createProperty(this)},l._action=function(a,b,c){return void 0!==a?void 0!==b?this.seek(b,c):c.call(this):void 0},l.read=function(a,b){return this._action(a,b,function(){return this.createProperty(a).read(this.contexts[0])})},l.readAll=function(){return this.read("jBinary.all",0)},l.write=function(a,b,c){return this._action(a,c,function(){var c=this.tell();return this.createProperty(a).write(b,this.contexts[0]),this.tell()-c})},l.writeAll=function(a){return this.write("jBinary.all",a,0)},function(a,b){for(var d=0,e=b.length;e>d;d++){var f=b[d];l.typeSet[f.toLowerCase()]=c(a,{dataType:f})}}(g({params:["littleEndian"],read:function(){return this.view["get"+this.dataType](void 0,this.littleEndian)},write:function(a){this.view["write"+this.dataType](a,this.littleEndian)}}),["Uint8","Uint16","Uint32","Uint64","Int8","Int16","Int32","Int64","Float32","Float64","Char"]),b(l.typeSet,{"byte":l.typeSet.uint8,"float":l.typeSet.float32,"double":l.typeSet.float64});var m=function(a){var b=this.seek(0,function(){return this.view.getString(void 0,void 0,this.view._isNodeBuffer?"base64":"binary")});return"data:"+a+";base64,"+(this.view._isNodeBuffer?b:btoa(b))};l.toURI=function(a){return m.call(this,a||this.typeSet["jBinary.mimeType"]||"application/octet-stream")};var n=!0&&require("stream").Readable;return f.loadData=e(function(b,c){var d;if(n&&b instanceof n){var e=[];b.on("readable",function(){e.push(this.read())}).on("end",function(){c(null,Buffer.concat(e))}).on("error",c)}else{if("string"!=typeof b)return c(new TypeError("Unsupported source type."));if(d=b.match(/^data:(.+?)(;base64)?,(.*)$/))try{var f=d[2],g=d[3];c(null,f&&a.prototype.compatibility.NodeBuffer?new Buffer(g,"base64"):(f?atob:decodeURIComponent)(g))}catch(h){c(h)}else{/^(https?):\/\//.test(b)?require("request").get({uri:b,encoding:null},function(a,b,d){if(!a&&200!==b.statusCode){var e=require("http").STATUS_CODES[b.statusCode];a=new Error("HTTP Error #"+b.statusCode+": "+e)}c(a,d)}):require("fs").readFile(b,c)}}}),f.load=e(function(a,b,c){"function"==typeof b&&(c=b,b=void 0),f.loadData(a,function(a,d){a?c(a):c(null,new f(d,b))})}),f});